# parameters:
#   name: software collection name, e.g. httpd24
#   namespace: SCL namespace/prefix, e.g. rh
#   release: version of CentOS to test, e.g. 6
#   arch: architecture of CentOS to test, e.g. x86_64
#   gituser: name of github user or organization
#   gitproject: name of a repository to test
#   project_trigger: projects which can trigger this job
#   context: context name for github statuses
- job-template:
    name: 'SCLo-container-{name}-{namespace}'
    properties:
      - github:
          url: https://github.com/{gituser}/{gitproject}
      - raw:
          xml: |
            <com.chikli.hudson.plugin.naginator.NaginatorOptOutProperty plugin="naginator@1.17.1">
              <optOut>true</optOut>
            </com.chikli.hudson.plugin.naginator.NaginatorOptOutProperty>
    node: sclo-sig
    scm:
        - images-pull-test:
            gituser: '{gituser}'
            gitproject: '{gitproject}'
    triggers:
        - github-pr:
            context: '{context}'
    builders:
        - shell: |
            cico node get -f value --arch {arch} --release {release} --count 1 --api-key $(cat ~/duffy.key) | tee cico.out
            tail -n 1 cico.out | cut -d ' ' -f 7 > ssid
            tail -n 1 cico.out | cut -d ' ' -f 2 > host
        - generate_ssh_config
        - shell: |
            scp -F ssh_config -rp $(pwd) host:sources
            ssh -F ssh_config host yum -y install docker perl git python-setuptools centos-release-scl-rh
            ssh -F ssh_config host yum -y install source-to-image
            ssh -F ssh_config host service docker start
            ssh -F ssh_config host 'sed -i -e "s|Defaults    requiretty||" /etc/sudoers'
            ssh -F ssh_config host 'cd sources && git submodule update --init'
            ssh -F ssh_config host make test SKIP_SQUASH=1 UPDATE_BASE=1 -C sources
    publishers:
        - cico_done
