# Requires:
# {gituser}
# {gitproject}
# {context}
- publisher:
    name: 'upload-log-rhscl-images'
    publishers:
    - postbuildscript:
        script-only-if-succeeded: false
        builders:
        - shell: |
            #!/bin/bash
            set -e

            curl -Ss "$BUILD_URL/consoleText" > build_log
            GIT_COMMIT=$(git rev-parse HEAD)
            GITHUB_USERNAME="rhscl-automation"
            repo_name=$(jq -r '.repository.name' <<< "$CI_MESSAGE")

            envsubst > upload.py <<EOF
            #!/usr/bin/python
            # -*- coding: utf-8 -*-
            # Create a Github Gist (an alternative to pastebin) which will be linked to from Github
            import json, requests, base64

            with open('build_log', 'r') as f: # Read the log of this build saved in a previous step
              build_log = f.read()

            gist = {{"description": "$GIT_COMMIT",
                    "public": False,
                    "files": {{
                       '{gitproject}' + '-#' + '$BUILD_NUMBER.sh' : {{
                         "content": build_log }} }} }}

            req = requests.post("https://api.github.com/gists", data=json.dumps(gist),
                              auth=('$GITHUB_USERNAME','$GITHUB_TOKEN'))

            api_res=json.loads(req.content)

            git_status = {{"description": "Build finished",
                          "public": False,
                          "target_url": api_res['html_url'],
                          "context": "Jenkins-CI for {context}",
                          "state": "success" }}

            req = requests.post("https://api.github.com/repos/{gituser}/{gitproject}/statuses/$GIT_COMMIT",
                                data=json.dumps(git_status),
                                auth=('$GITHUB_USERNAME', '$GITHUB_TOKEN'))
            EOF
            python upload.py

            rm build_log



- publisher:
    name: 'upload-log-SCLo-container'
    publishers:
    - postbuildscript:
        script-only-if-succeeded: false
        builders:
        - shell: |
            #!/bin/bash
            set -e

            # Do NOTHING!
