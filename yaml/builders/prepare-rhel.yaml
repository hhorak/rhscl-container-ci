- builder:
    name: 'prepare-rhscl-images'
    builders:
        - shell: |
            #!/bin/bash
            set -ex

            resalloc --connection http://172.16.39.21:49100/ ticket --tag rhel7 > ticket
            host=$(resalloc --connection http://172.16.39.21:49100/ ticket-wait $(cat ticket))

            cat > ssh_config << EOF
            UserKnownHostsFile /dev/null
            StrictHostKeyChecking no
            User root
            ConnectTimeout 10

            Host host
              Hostname ${host}
              IdentityFile ~/.ssh/id_rsa_resalloc
            EOF

            # Create script for cleanup
            cat > .cleanup.sh << EOF
            #!/bin/bash
            set -ex

            resalloc --connection http://172.16.39.21:49100/ ticket-close $(cat ticket)
            rm ticket ssh_config
            EOF
            chmod a+x .cleanup.sh

            # Prepare distgen (TEMPORARY FIX - https://gitlab.cee.redhat.com/platform-eng-core-services/coreservices-jenkins-slaves/merge_requests/16)
            ssh -F ssh_config host yum -y install epel-release
            ssh -F ssh_config host yum -y install distgen

            # Install docker-squash (TEMPORARY FIX - https://gitlab.cee.redhat.com/platform-eng-core-services/coreservices-jenkins-slaves/merge_requests/17)
            ssh -F ssh_config host yum -y install rh-python36-python-virtualenv
            ssh -F ssh_config host 'scl enable rh-python36 -- virtualenv --python python3 /usr/local/docker-squash && . /usr/local/docker-squash/bin/activate && \
              pip install "docker-squash==1.0.5" && echo ". /usr/local/docker-squash/bin/activate" > /root/.bashrc'
