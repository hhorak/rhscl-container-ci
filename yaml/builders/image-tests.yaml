# Requires:
# {OS}
# {release}
- builder:
    name: 'image-tests'
    builders:
        - shell: |
            #!/bin/bash
            set -ex

            # Run make for base image and for each dependent image
            timeout 2h ssh -F ssh_config host 'set -ex; setenforce 0; \
              cd sources; make test TARGET={OS}{release} UPDATE_BASE=1 TAG_ON_SUCCESS=true; \
              for remote in $(git remote | grep test_); do \
                echo "Testing ${{remote#test_}}/master"; \
                git checkout $remote/master; \
                git submodule update --init; \
                make test TARGET={OS}{release}; \
              done'

