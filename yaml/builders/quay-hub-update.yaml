# Requires:
# {targetOS}
# {gitproject}
# {gituser}
- builder:
    name: 'quay-hub-update'
    parameters:
        - string:
              name: description
              default: ''
              description: ""

    builders:
        - shell: |
            #!/bin/bash
            set -ex
            envsubst > upload_quay.sh << 'EOF'
            echo -n '{{"description":"' > data.json
            echo -n $2 >> data.json
            echo -n '"}}' >> data.json

            curl -d @data.json -X PUT -k -H "Authorization: Bearer $QUAY_OAUTH_TOKEN" \
                 -H 'Content-Type: application/json' \
                 https://quay.io/api/v1/repository/{targetOS}/$1
            EOF
            # Update Quay.io image description
            rsync -avzP -e 'ssh -F ssh_config' $(pwd)/upload_quay.sh host:sources/upload_quay.sh

            ssh -F ssh_config host << 'EOF'
              set -ex; cd sources;

              for version in $(grep "VERSIONS = " Makefile | sed "s|VERSIONS = ||"); do
                for image in $(make tag TARGET={targetOS} VERSIONS=${{version}} | grep -- '-> Tagging image' | cut -d' ' -f 6 | sed "s/'//g"); do
                  echo "Updating summary for ${{image}}"
                  description=$(docker inspect --format='{{{{.Config.Labels.description}}}}' ${{image}} || "")
                  if [ ${{#description}} -gt 100 ] ; then
                    description="${{description:0:96}}..."
                  fi
                  name=${{image##*/}}
                  echo "Update Quay.io with description and link to README.md on GitHub"
                  if [ -L ${{version}}/README.md ] ; then
                    # In case e.g. in redis-container
                    # 5/README.md -> root/usr/share/container-scripts/redis/README.md
                    # Then we have to update link to 5/root/usr/share/container-scripts/redis/README.md
                    REAL_FILE=$(readlink ${{version}}/README.md)
                    description="${{description}}.<br>Learn more <a href=\\\"https://github.com/{gituser}/{gitproject}/${{version}}/${{REAL_FILE}}\\\">https://github.com/{gituser}/{gitproject}/${{version}}/${{REAL_FILE}}</a>"
                    bash upload_quay.sh ${{name%:*}} "${{description}}"
                  elif [ -f ${{version}}/README.md ]; then
                    description="${{description}}.<br>Learn more <a href=\\\"https://github.com/{gituser}/{gitproject}/${{version}}/README.md\\\">https://github.com/{gituser}/{gitproject}/${{version}}/README.md</a>"
                    bash upload_quay.sh ${{name%:*}} "${{description}}"
                  fi
                  done
              done
            EOF
